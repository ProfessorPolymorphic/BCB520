{
  "hash": "66731b2f532a8b9ac69204bd88688507",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"BCB 520 - Fatty Acids\"\nsubtitle: \"Synthetic Data!\"\nformat:\n  html:\n    toc: false\n    echo: true\nauthor: \"Barrie Robison\"\ndate: \"2025-03-14\"\ncategories: [Portfolio, DataViz, Observable, Animation]\nimage: \"Zomsimmesh.png\"\ndescription: \"Sharon's data\"\ncode-fold: true\ncode-tools: true\neval: false\n\n---\n\n\n\n\n\n## PREAMBLE\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(readxl)\n```\n:::\n\n\n\n\n\n\n\n## Data\n\nCreate a synthetic data set.\n\n\n# Maternal Diet and Breast Milk Fatty Acid Analysis\n\n## Dataset Description\n\nThis synthetic dataset mimics data collection from a study of 21 women who provided diet and breast milk samples at 6 timepoints postpartum. The data includes:\n\n- 21 women (mother IDs 1-21)\n- 6 timepoints per woman (approximately weekly sampling starting in the first week postpartum)\n- 40 fatty acids measured in diet (percentage of total fatty acids)\n- 37 fatty acids measured in breast milk (percentage of total fatty acids)\n\nThe dataset includes common fatty acid types:\n- Saturated fatty acids (e.g., C16:0 palmitic acid, C18:0 stearic acid)\n- Monounsaturated fatty acids (e.g., C18:1n9 oleic acid)\n- Polyunsaturated fatty acids (PUFAs)\n  - Omega-6 (e.g., C18:2n6 linoleic acid, C20:4n6 arachidonic acid)\n  - Omega-3 (e.g., C18:3n3 alpha-linolenic acid, C22:6n3 docosahexaenoic acid/DHA)\n- Trans fatty acids (e.g., C18:1t)\n\nThe dataset incorporates biologically plausible relationships:\n- Diet influences milk fatty acid composition (especially for essential fatty acids)\n- Individual women have their own baseline patterns\n- Some fatty acids show time-dependent changes in milk (e.g., medium-chain FAs often increase)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Generate synthetic data for fatty acid profiles in diet and breast milk\n\nlibrary(tidyverse)\n\n# Define constants\nNUM_WOMEN <- 21\nNUM_TIME_POINTS <- 6\nNUM_DIET_FAS <- 40\nNUM_MILK_FAS <- 37\n\n# Generate fatty acid names\ngenerate_fatty_acid_names <- function(count) {\n  # Common fatty acid naming patterns\n  fatty_acids <- c(\n    # Saturated FAs\n    \"C4:0\", \"C6:0\", \"C8:0\", \"C10:0\", \"C12:0\", \"C14:0\", \"C16:0\", \"C18:0\", \"C20:0\", \"C22:0\", \"C24:0\",\n    # Monounsaturated FAs\n    \"C14:1\", \"C16:1\", \"C18:1n9\", \"C18:1n7\", \"C20:1n9\", \"C22:1n9\", \"C24:1n9\",\n    # Polyunsaturated FAs - Omega-6\n    \"C18:2n6\", \"C18:3n6\", \"C20:2n6\", \"C20:3n6\", \"C20:4n6\", \"C22:2n6\", \"C22:4n6\", \"C22:5n6\",\n    # Polyunsaturated FAs - Omega-3\n    \"C18:3n3\", \"C18:4n3\", \"C20:3n3\", \"C20:4n3\", \"C20:5n3\", \"C22:5n3\", \"C22:6n3\",\n    # Trans FAs\n    \"C16:1t\", \"C18:1t\", \"C18:2t\"\n  )\n  \n  # For any additional fatty acids needed beyond the common ones\n  if (count > length(fatty_acids)) {\n    additional_names <- character(count - length(fatty_acids))\n    for (i in 1:length(additional_names)) {\n      # Generate additional names in realistic pattern\n      carbon_chain <- sample(4:24, 1)  # C4 to C24\n      double_bonds <- sample(0:5, 1) \n      name <- paste0(\"C\", carbon_chain, \":\", double_bonds)\n      if (double_bonds > 0) {\n        position <- sample(1:10, 1)\n        name <- paste0(name, \"n\", position)\n      }\n      additional_names[i] <- name\n    }\n    fatty_acids <- c(fatty_acids, additional_names)\n  }\n  \n  return(fatty_acids[1:count])\n}\n\n# Generate the synthetic dataset\ngenerate_synthetic_data <- function() {\n  # Generate names for diet and milk fatty acids\n  diet_fa_names <- generate_fatty_acid_names(NUM_DIET_FAS)\n  milk_fa_names <- diet_fa_names[1:NUM_MILK_FAS]  # Most milk FAs will be the same as diet FAs\n  \n  # Create empty dataframes with appropriate columns\n  diet_columns <- c(\"woman_id\", \"timepoint\", \"days_postpartum\", diet_fa_names)\n  milk_columns <- c(\"woman_id\", \"timepoint\", \"days_postpartum\", milk_fa_names)\n  \n  diet_data <- data.frame(matrix(NA, nrow = 0, ncol = length(diet_columns)))\n  names(diet_data) <- diet_columns\n  \n  milk_data <- data.frame(matrix(NA, nrow = 0, ncol = length(milk_columns)))\n  names(milk_data) <- milk_columns\n  \n  # Generate data for each woman\n  for (woman in 1:NUM_WOMEN) {\n    # Individual baseline characteristics that will influence their FA profiles\n    diet_pattern <- runif(1)    # 0 = low fat, 1 = high fat\n    omega3_intake <- runif(1)   # 0 = low, 1 = high\n    omega6_intake <- runif(1)   # 0 = low, 1 = high\n    \n    # For each time point\n    for (timepoint in 1:NUM_TIME_POINTS) {\n      # Days postpartum (approximately weekly)\n      days_postpartum <- (timepoint - 1) * 7 + sample(0:2, 1)\n      \n      # Create new rows for diet and milk\n      diet_row <- data.frame(woman_id = woman, \n                            timepoint = timepoint,\n                            days_postpartum = days_postpartum)\n      \n      milk_row <- data.frame(woman_id = woman, \n                            timepoint = timepoint,\n                            days_postpartum = days_postpartum)\n      \n      # Major fatty acids (higher abundance)\n      major_fas <- c(\"C16:0\", \"C18:0\", \"C18:1n9\", \"C18:2n6\")\n      # Medium abundance fatty acids\n      medium_fas <- c(\"C12:0\", \"C14:0\", \"C18:3n3\", \"C20:4n6\", \"C22:6n3\")\n      \n      # Generate diet fatty acid values\n      for (fa in diet_fa_names) {\n        if (fa %in% major_fas) {\n          # Major FAs (10-30%)\n          diet_row[[fa]] <- runif(1, 10, 30)\n        } else if (fa %in% medium_fas) {\n          # Medium FAs (1-10%)\n          diet_row[[fa]] <- runif(1, 1, 10)\n        } else {\n          # Minor FAs (<1%)\n          diet_row[[fa]] <- runif(1, 0.1, 1)\n        }\n        \n        # Apply individual characteristics\n        if (grepl(\"n3$\", fa)) {\n          diet_row[[fa]] <- diet_row[[fa]] * (0.5 + omega3_intake)\n        } else if (grepl(\"n6$\", fa)) {\n          diet_row[[fa]] <- diet_row[[fa]] * (0.5 + omega6_intake)\n        }\n        \n        # Round to 2 decimal places\n        diet_row[[fa]] <- round(diet_row[[fa]], 2)\n      }\n      \n      # Generate milk fatty acid values based on diet\n      for (fa in milk_fa_names) {\n        if (fa %in% major_fas) {\n          # Major FAs (10-30%)\n          base_value <- runif(1, 10, 30)\n        } else if (fa %in% medium_fas) {\n          # Medium FAs (1-10%)\n          base_value <- runif(1, 1, 10)\n        } else {\n          # Minor FAs (<1%)\n          base_value <- runif(1, 0.1, 1)\n        }\n        \n        # Milk FA reflects diet FA but with biological processing\n        if (fa %in% diet_fa_names) {\n          # For essential FAs that transfer more directly\n          if (grepl(\"C18:2n6|C18:3n3|C20:5n3|C22:6n3\", fa)) {\n            # 60-80% correlation with diet for essential FAs\n            milk_row[[fa]] <- diet_row[[fa]] * (0.6 + runif(1, 0, 0.2)) + \n                             base_value * (0.2 + runif(1, 0, 0.2))\n          } else {\n            # 30-50% correlation for other FAs\n            milk_row[[fa]] <- diet_row[[fa]] * (0.3 + runif(1, 0, 0.2)) + \n                             base_value * (0.5 + runif(1, 0, 0.2))\n          }\n        } else {\n          milk_row[[fa]] <- base_value\n        }\n        \n        # Time-dependent changes\n        if (grepl(\"C12:0|C14:0\", fa)) {\n          # Medium chain FAs often increase slightly in milk over time\n          milk_row[[fa]] <- milk_row[[fa]] * (1 + (timepoint - 1) * 0.05)\n        } else if (fa == \"C22:6n3\") { # DHA\n          # DHA often decreases slightly if not supplemented\n          milk_row[[fa]] <- milk_row[[fa]] * (1 - (timepoint - 1) * 0.03)\n        }\n        \n        # Round to 2 decimal places\n        milk_row[[fa]] <- round(milk_row[[fa]], 2)\n      }\n      \n      # Add rows to dataframes\n      diet_data <- rbind(diet_data, diet_row)\n      milk_data <- rbind(milk_data, milk_row)\n    }\n  }\n  \n  return(list(diet_data = diet_data, milk_data = milk_data))\n}\n\n# Generate the data\nset.seed(123)  # For reproducibility\nsynthetic_data <- generate_synthetic_data()\n\n# Write to CSV files\nwrite.csv(synthetic_data$diet_data, \"diet_fatty_acids.csv\", row.names = FALSE)\nwrite.csv(synthetic_data$milk_data, \"milk_fatty_acids.csv\", row.names = FALSE)\n\n# Preview the data\nhead(synthetic_data$diet_data[, 1:10])  # Show first 10 columns\nhead(synthetic_data$milk_data[, 1:10])  # Show first 10 columns\n\n# Verify data integrity\ncat(\"Diet data dimensions:\", dim(synthetic_data$diet_data), \"\\n\")\ncat(\"Milk data dimensions:\", dim(synthetic_data$milk_data), \"\\n\")\n\n# Check if values are plausible\ncat(\"Diet data range:\", range(as.matrix(synthetic_data$diet_data[, -(1:3)])), \"\\n\")\ncat(\"Milk data range:\", range(as.matrix(synthetic_data$milk_data[, -(1:3)])), \"\\n\")\n\n# Verify that key fatty acids are present\ncat(\"Key FAs in diet:\", \n    c(\"C16:0\", \"C18:0\", \"C18:1n9\", \"C18:2n6\", \"C18:3n3\", \"C20:4n6\", \"C22:6n3\") %in% colnames(synthetic_data$diet_data), \n    \"\\n\")\ncat(\"Key FAs in milk:\", \n    c(\"C16:0\", \"C18:0\", \"C18:1n9\", \"C18:2n6\", \"C18:3n3\", \"C20:4n6\", \"C22:6n3\") %in% colnames(synthetic_data$milk_data), \n    \"\\n\")\n\n# Calculate some basic descriptive statistics\ndiet_means <- colMeans(synthetic_data$diet_data[, -(1:3)])\nmilk_means <- colMeans(synthetic_data$milk_data[, -(1:3)])\n\ncat(\"Top 5 most abundant fatty acids in diet:\\n\")\nprint(sort(diet_means, decreasing = TRUE)[1:5])\n\ncat(\"Top 5 most abundant fatty acids in milk:\\n\")\nprint(sort(milk_means, decreasing = TRUE)[1:5])\n\n# Check correlation between diet and milk for key fatty acids\nkey_fas <- c(\"C16:0\", \"C18:0\", \"C18:1n9\", \"C18:2n6\", \"C18:3n3\", \"C20:4n6\", \"C22:6n3\")\n\ncat(\"Diet-milk correlations for key fatty acids:\\n\")\ncorrelations <- sapply(key_fas, function(fa) {\n  cor(synthetic_data$diet_data[[fa]], synthetic_data$milk_data[[fa]])\n})\nnames(correlations) <- key_fas\nprint(correlations)\n```\n:::\n\n\n\n\n\n## Data Files\n\nTwo CSV files are provided:\n- `diet_fatty_acids.csv`: Diet fatty acid profiles\n- `milk_fatty_acids.csv`: Breast milk fatty acid profiles\n\nEach file contains columns for:\n- `woman_id`: Unique ID for each woman (1-21)\n- `timepoint`: Sampling timepoint (1-6)\n- `days_postpartum`: Days since birth (varies slightly around weekly intervals)\n- Individual columns for each fatty acid (values in percentage of total fatty acids)\n\n## Analysis Approaches in R\n\nBelow are several R code examples demonstrating different analysis and visualization approaches for this dataset.\n\n### Setup and Data Import\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import libraries\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(reshape2)\nlibrary(vegan)    # For multivariate analyses\nlibrary(pheatmap) # For heatmaps\nlibrary(corrplot) # For correlation plots\n\n# Import the data\ndiet_data <- read.csv(\"diet_fatty_acids.csv\")\nmilk_data <- read.csv(\"milk_fatty_acids.csv\")\n\n# Convert to long format for some analyses\ndiet_long <- diet_data %>%\n  pivot_longer(cols = -c(woman_id, timepoint, days_postpartum),\n               names_to = \"fatty_acid\", \n               values_to = \"abundance\")\n\nmilk_long <- milk_data %>%\n  pivot_longer(cols = -c(woman_id, timepoint, days_postpartum),\n               names_to = \"fatty_acid\", \n               values_to = \"abundance\")\n```\n:::\n\n\n\n\n\n### Analysis 1: Time Series Analysis\n\nTrack changes in specific fatty acids (e.g., DHA) over time:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_fa_trajectory <- function(data_long, target_fa) {\n  require(ggplot2)\n  \n  fa_data <- data_long %>% \n    filter(fatty_acid == target_fa)\n  \n  p <- ggplot(fa_data, aes(x = days_postpartum, y = abundance, \n                       group = woman_id, color = factor(woman_id))) +\n    geom_line() +\n    geom_point() +\n    labs(title = paste0(target_fa, \" Abundance Over Time\"),\n         x = \"Days Postpartum\",\n         y = \"Abundance (% of total FAs)\",\n         color = \"Woman ID\") +\n    theme_minimal()\n  \n  return(p)\n}\n\n# DHA in milk over time \nmilk_dha <- milk_long %>% \n  filter(fatty_acid == \"C18.2n6\")\n\nggplot(milk_dha, aes(x = days_postpartum, y = abundance, \n                     group = woman_id, color = factor(woman_id))) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Fatty Acid Classes in Breast Milk Over Time\",\n       x = \"Timepoint\",\n       y = \"Total Abundance (%)\",\n       fill = \"Fatty Acid Class\") +\n  theme_minimal()\n\n\n\n\n# Calculate omega-6/omega-3 ratio\nomega_ratio <- milk_class_totals %>%\n  filter(fa_class %in% c(\"Omega-3\", \"Omega-6\")) %>%\n  pivot_wider(id_cols = c(woman_id, timepoint, days_postpartum),\n              names_from = fa_class,\n              values_from = total_abundance) %>%\n  mutate(omega6_omega3_ratio = `Omega-6` / `Omega-3`)\n\nggplot(omega_ratio, aes(x = days_postpartum, y = omega6_omega3_ratio, \n                       group = woman_id, color = factor(woman_id))) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"Omega-6/Omega-3 Ratio in Breast Milk Over Time\",\n       x = \"Days Postpartum\",\n       y = \"Omega-6/Omega-3 Ratio\",\n       color = \"Woman ID\") +\n  theme_minimal()\n```\n:::\n\n\n\n\n# Multivariate visualization with PCA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_analysis <- function(data, id_cols = c(\"woman_id\", \"timepoint\")) {\n  require(ggplot2)\n  \n  # Extract just the FA columns for PCA\n  fa_cols <- data %>% select(-all_of(id_cols))\n  \n  # Run PCA\n  pca_result <- prcomp(fa_cols, scale. = TRUE)\n  \n  # Extract scores\n  pca_scores <- as.data.frame(pca_result$x)\n  \n  # Add back identifiers\n  for(col in id_cols) {\n    pca_scores[[col]] <- data[[col]]\n  }\n  \n  # Create plot\n  p <- ggplot(pca_scores, aes(x = PC1, y = PC2, \n                         color = factor(woman_id), \n                         shape = factor(timepoint))) +\n    geom_point(size = 3) +\n    labs(title = \"PCA of Fatty Acid Profiles\",\n         color = \"Woman ID\",\n         shape = \"Timepoint\") +\n    theme_minimal()\n  \n  # Return both plot and PCA results\n  return(list(plot = p, pca = pca_result, scores = pca_scores))\n}\n\npca_analysis(diet_data)\npca_analysis(milk_data)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npcoa_comparison <- function(diet_data, milk_data, id_cols = c(\"woman_id\", \"timepoint\"), \n                           distance_method = \"bray\") {\n  require(ggplot2)\n  require(dplyr)\n  require(vegan)  # for distance and pcoa calculations\n  \n  # Function to run PCoA and return results\n  run_pcoa <- function(data, id_cols, distance_method) {\n    # Extract just the feature columns for PCoA\n    feature_cols <- data %>% select(-all_of(id_cols))\n    \n    # Calculate distance matrix\n    dist_matrix <- vegdist(feature_cols, method = distance_method)\n    \n    # Run PCoA\n    pcoa_result <- cmdscale(dist_matrix, eig = TRUE, k = min(nrow(feature_cols) - 1, 10))\n    \n    # Calculate proportion of variance explained\n    eigenvalues <- pcoa_result$eig\n    prop_variance <- eigenvalues / sum(eigenvalues)\n    \n    # Extract scores\n    pcoa_scores <- as.data.frame(pcoa_result$points)\n    colnames(pcoa_scores) <- paste0(\"Axis\", 1:ncol(pcoa_scores))\n    \n    # Add back identifiers\n    for(col in id_cols) {\n      pcoa_scores[[col]] <- data[[col]]\n    }\n    \n    return(list(pcoa = pcoa_result, scores = pcoa_scores, variance = prop_variance))\n  }\n  \n  # Run PCoA on both datasets\n  diet_pcoa <- run_pcoa(diet_data, id_cols, distance_method)\n  milk_pcoa <- run_pcoa(milk_data, id_cols, distance_method)\n  \n  # Create individual plots\n  diet_plot <- ggplot(diet_pcoa$scores, aes(x = Axis1, y = Axis2, \n                           color = factor(woman_id), \n                           shape = factor(timepoint))) +\n    geom_point(size = 3) +\n    labs(title = \"PCoA of Diet Profiles\",\n         x = paste0(\"Axis 1 (\", round(diet_pcoa$variance[1] * 100, 1), \"%)\"),\n         y = paste0(\"Axis 2 (\", round(diet_pcoa$variance[2] * 100, 1), \"%)\"),\n         color = \"Woman ID\",\n         shape = \"Timepoint\") +\n    theme_minimal()\n  \n  milk_plot <- ggplot(milk_pcoa$scores, aes(x = Axis1, y = Axis2, \n                           color = factor(woman_id), \n                           shape = factor(timepoint))) +\n    geom_point(size = 3) +\n    labs(title = \"PCoA of Milk Fatty Acid Profiles\",\n         x = paste0(\"Axis 1 (\", round(milk_pcoa$variance[1] * 100, 1), \"%)\"),\n         y = paste0(\"Axis 2 (\", round(milk_pcoa$variance[2] * 100, 1), \"%)\"),\n         color = \"Woman ID\",\n         shape = \"Timepoint\") +\n    theme_minimal()\n  \n  # Join the PCoA scores for correlation analysis\n  # Match by both woman_id and timepoint\n  join_cols <- c(\"woman_id\", \"timepoint\")\n  comparison_data <- diet_pcoa$scores %>%\n    select(all_of(join_cols), starts_with(\"Axis\")) %>%\n    rename_with(~paste0(\"diet_\", .), starts_with(\"Axis\")) %>%\n    inner_join(\n      milk_pcoa$scores %>%\n        select(all_of(join_cols), starts_with(\"Axis\")) %>%\n        rename_with(~paste0(\"milk_\", .), starts_with(\"Axis\")),\n      by = join_cols\n    )\n  \n  # Calculate correlations between diet PCs and milk PCs\n  diet_axes <- grep(\"^diet_Axis\", names(comparison_data), value = TRUE)\n  milk_axes <- grep(\"^milk_Axis\", names(comparison_data), value = TRUE)\n  \n  correlation_matrix <- matrix(NA, length(diet_axes), length(milk_axes))\n  rownames(correlation_matrix) <- diet_axes\n  colnames(correlation_matrix) <- milk_axes\n  \n  for(i in 1:length(diet_axes)) {\n    for(j in 1:length(milk_axes)) {\n      correlation_matrix[i, j] <- cor(comparison_data[[diet_axes[i]]], \n                                   comparison_data[[milk_axes[j]]], \n                                   use = \"complete.obs\")\n    }\n  }\n  \n  # Create correlation heatmap\n  correlation_df <- as.data.frame(as.table(correlation_matrix))\n  names(correlation_df) <- c(\"Diet_Axis\", \"Milk_Axis\", \"Correlation\")\n  \n  correlation_plot <- ggplot(correlation_df, aes(x = Diet_Axis, y = Milk_Axis, fill = Correlation)) +\n    geom_tile() +\n    scale_fill_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n    geom_text(aes(label = round(Correlation, 2)), color = \"black\", size = 3) +\n    labs(title = \"Correlation Between Diet and Milk PCoA Components\",\n         subtitle = paste(\"Distance method:\", distance_method)) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n  \n  # Scatter plot of top correlated components\n  # Find highest absolute correlation\n  top_correlation <- correlation_df %>%\n    mutate(abs_cor = abs(Correlation)) %>%\n    arrange(desc(abs_cor)) %>%\n    slice(1)\n  \n  scatter_plot <- ggplot(comparison_data, \n                        aes_string(x = top_correlation$Diet_Axis, \n                                  y = top_correlation$Milk_Axis,\n                                  color = \"factor(woman_id)\",\n                                  shape = \"factor(timepoint)\")) +\n    geom_point(size = 3) +\n    geom_smooth(method = \"lm\", se = TRUE, color = \"black\", aes(group = 1)) +\n    labs(title = paste(\"Relationship Between\", top_correlation$Diet_Axis, \"and\", \n                      top_correlation$Milk_Axis),\n         subtitle = paste(\"Correlation:\", round(top_correlation$Correlation, 3)),\n         color = \"Woman ID\",\n         shape = \"Timepoint\") +\n    theme_minimal()\n  \n  # Return all results\n  return(list(\n    diet_pcoa = diet_pcoa,\n    milk_pcoa = milk_pcoa,\n    diet_plot = diet_plot,\n    milk_plot = milk_plot,\n    correlation_matrix = correlation_matrix,\n    correlation_plot = correlation_plot,\n    comparison_data = comparison_data,\n    scatter_plot = scatter_plot\n  ))\n}\n\n# Use the function\nresults <- pcoa_comparison(diet_data, milk_data, distance_method = \"bray\")\n\n# View individual plots\nresults$diet_plot\nresults$milk_plot\nresults$correlation_plot\nresults$scatter_plot\n\n# Optional: Examine specific correlations\nround(results$correlation_matrix, 2)\n```\n:::\n\n\n\n\n\n\n\n# Correlation analysis between diet and milk\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorrelation_analysis <- function(diet_long, milk_long) {\n  require(ggplot2)\n  \n  # Join diet and milk data for correlation analysis\n  joined_data <- diet_long %>%\n    inner_join(milk_long, \n               by = c(\"woman_id\", \"timepoint\", \"days_postpartum\", \"fatty_acid\"),\n               suffix = c(\"_diet\", \"_milk\"))\n  \n  # Calculate correlations for each fatty acid\n  correlations <- joined_data %>%\n    group_by(fatty_acid) %>%\n    summarize(correlation = cor(abundance_diet, abundance_milk, method = \"spearman\"),\n              p_value = cor.test(abundance_diet, abundance_milk, method = \"spearman\")$p.value)\n  \n  # Plot the correlations\n  p <- ggplot(correlations, aes(x = reorder(fatty_acid, correlation), y = correlation)) +\n    geom_bar(stat = \"identity\", aes(fill = p_value < 0.05)) +\n    coord_flip() +\n    labs(title = \"Correlation Between Diet and Milk Fatty Acid Abundance\",\n         x = \"Fatty Acid\",\n         y = \"Spearman Correlation\",\n         fill = \"P < 0.05\") +\n    theme_minimal()\n  \n  return(list(plot = p, correlations = correlations))\n}\n\n\ncorrelation_analysis(diet_long, milk_long)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Heatmap visualization by timepoint\nheatmap_by_timepoint <- function(data, timepoint_val, scale = \"column\") {\n  require(pheatmap)\n  \n  # Prepare data for heatmap\n  heatmap_data <- data %>%\n    filter(timepoint == timepoint_val) %>%\n    select(-timepoint, -days_postpartum) %>%\n    column_to_rownames(\"woman_id\")\n  \n  # Create heatmap\n  pheatmap(heatmap_data,\n           scale = scale,\n           clustering_distance_rows = \"euclidean\",\n           clustering_distance_cols = \"euclidean\",\n           main = paste0(\"Fatty Acid Profiles at Timepoint \", timepoint_val))\n  \n  # Option 1: Correlation-based clustering\npheatmap(heatmap_data,\n         scale = \"column\",  # Scaling by row often works well for metabolite data\n         clustering_distance_rows = \"correlation\",\n         clustering_distance_cols = \"correlation\",\n         clustering_method = \"average\",\n         main = paste0(\"Fatty Acid Profiles at Timepoint \", timepoint_val))\n\n# Option 2: Ward's hierarchical clustering\npheatmap(heatmap_data,\n         scale = \"column\", \n         clustering_distance_rows = \"euclidean\",\n         clustering_distance_cols = \"euclidean\",\n         clustering_method = \"ward.D2\",\n         main = paste0(\"Fatty Acid Profiles at Timepoint \", timepoint_val))\n  \n}\n\nheatmap_by_timepoint(milk_data, 1)\n```\n:::\n\n\n\n\n\n\n\n### Analysis 8: Clustering to Identify Diet Patterns\n\nUse clustering to identify diet patterns and their relationship to milk composition:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Focus on dietary patterns using key fatty acids\nkey_fas <- c(\"C16.0\", \"C18.0\", \"C18.1n9\", \"C18.2n6\", \"C18.3n3\", \"C20.4n6\", \"C20.5n3\", \"C22.6n3\")\n\n# Extract diet data for clustering\ndiet_for_cluster <- diet_data %>%\n  select(woman_id, timepoint, all_of(key_fas)) %>%\n  group_by(woman_id) %>%\n  summarize(across(all_of(key_fas), mean)) %>%\n  column_to_rownames(\"woman_id\")\n\n# Perform hierarchical clustering\ndiet_dist <- dist(diet_for_cluster)\ndiet_hclust <- hclust(diet_dist)\n\n# Cut the tree to get 3 clusters\ndiet_clusters <- cutree(diet_hclust, k = 3)\ndiet_clusters_df <- data.frame(\n  woman_id = as.integer(names(diet_clusters)),\n  diet_cluster = diet_clusters\n)\n\ndiet_for_plot <- diet_for_cluster %>%\n  rownames_to_column(\"woman_id\") %>%\n  mutate(woman_id = as.integer(woman_id)) %>%\n  left_join(diet_clusters_df, by = \"woman_id\")\n\n# PCA for visualization\ndiet_pca <- prcomp(diet_for_cluster, scale. = TRUE)\ndiet_pca_df <- data.frame(\n  woman_id = as.integer(rownames(diet_for_cluster)),\n  PC1 = diet_pca$x[,1],\n  PC2 = diet_pca$x[,2]\n) %>%\n  left_join(diet_clusters_df, by = \"woman_id\")\n\nggplot(diet_pca_df, aes(x = PC1, y = PC2, color = factor(diet_cluster))) +\n  geom_point(size = 3) +\n  labs(title = \"Dietary Pattern Clusters\",\n       color = \"Cluster\") +\n  theme_minimal()\n\n# Examine how diet clusters relate to milk composition\nmilk_by_cluster <- milk_long %>%\n  inner_join(diet_clusters_df, by = \"woman_id\") %>%\n  filter(fatty_acid %in% key_fas) %>%\n  group_by(diet_cluster, fatty_acid) %>%\n  summarize(mean_abundance = mean(abundance))\n\nggplot(milk_by_cluster, aes(x = fatty_acid, y = mean_abundance, fill = factor(diet_cluster))) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  labs(title = \"Milk Fatty Acid Composition by Diet Cluster\",\n       x = \"Fatty Acid\",\n       y = \"Mean Abundance (%)\",\n       fill = \"Diet Cluster\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n:::\n\n\n\n\n\n### Analysis 9: Network Analysis of Fatty Acid Correlations\n\nExamine relationships between fatty acids using network visualization:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(igraph)\nlibrary(ggraph)\n\n# Calculate correlations\nmilk_wide_for_cor <- milk_data %>%\n  select(-woman_id, -timepoint, -days_postpartum)\nmilk_cor <- cor(milk_wide_for_cor, use = \"pairwise.complete.obs\")  # Handle any NAs\n\n# Convert to data frame for analysis\nmilk_cor_df_all <- as.data.frame(as.table(milk_cor)) %>%\n  rename(FA1 = Var1, FA2 = Var2, Correlation = Freq) %>%\n  filter(FA1 != FA2)  # Remove self-correlations\n\n# Check the distribution of correlation values\nsummary(milk_cor_df_all$Correlation)\n\n# Try a lower threshold to see if any correlations exist\nmilk_cor_df <- milk_cor_df_all %>%\n  filter(abs(Correlation) > 0.25)  # Lower threshold\n\n# See how many correlations we get with the lower threshold\nnrow(milk_cor_df)\n\n# Create a graph\nmilk_graph <- graph_from_data_frame(milk_cor_df, directed = FALSE)\nE(milk_graph)$weight <- milk_cor_df$Correlation\nE(milk_graph)$color <- ifelse(E(milk_graph)$weight > 0, \"blue\", \"red\")\nE(milk_graph)$width <- abs(E(milk_graph)$weight) * 2\n\n# Plot the network\nset.seed(123)  # For reproducibility\nplot(milk_graph, \n     edge.width = E(milk_graph)$width,\n     edge.color = E(milk_graph)$color,\n     main = \"Network of Fatty Acid Correlations in Breast Milk\")\n\n# Use absolute weights for the layout, but keep the original sign for visualization\nggraph(milk_graph, layout = 'fr', weights = abs(E(milk_graph)$weight)) + \n  geom_edge_link(aes(edge_alpha = abs(weight), edge_width = abs(weight), color = weight > 0)) +\n  geom_node_point(size = 5) +\n  geom_node_text(aes(label = name), repel = TRUE) +\n  scale_edge_color_manual(values = c(\"red\", \"blue\"), labels = c(\"Negative\", \"Positive\")) +\n  labs(title = \"Network of Fatty Acid Correlations in Breast Milk\",\n       edge_color = \"Correlation Type\") +\n  theme_void()\n```\n:::\n\n\n\n\n\n## Additional Visualization Ideas\n\n### Interactive Visualizations (using plotly)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(plotly)\n\n# Interactive time series\ndha_plot <- ggplot(milk_dha, aes(x = days_postpartum, y = abundance, \n                              group = woman_id, color = factor(woman_id))) +\n  geom_line() +\n  geom_point() +\n  labs(title = \"DHA in Breast Milk Over Time\",\n       x = \"Days Postpartum\",\n       y = \"Abundance (% of total FAs)\",\n       color = \"Woman ID\") +\n  theme_minimal()\n\nggplotly(dha_plot)\n\n# Interactive PCA plot\npca_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2, \n                                 color = factor(woman_id), \n                                 shape = factor(timepoint),\n                                 text = paste(\"Woman:\", woman_id, \n                                              \"\\nTimepoint:\", timepoint))) +\n  geom_point(size = 3) +\n  labs(title = \"PCA of Breast Milk Fatty Acid Profiles\",\n       color = \"Woman ID\",\n       shape = \"Timepoint\") +\n  theme_minimal()\n\nggplotly(pca_plot)\n```\n:::\n\n\n\n\n\n### Radar/Spider Plots (for comparing profiles)\n\n```r\nlibrary(fmsb)\n\n# Prepare data for radar plot (example for comparing diet clusters)\nradar_data <- milk_by_cluster %>%\n  pivot_wider(id_cols = diet_cluster, names_from = fatty_acid, values_from = mean_abundance) %>%\n  as.data.frame()\n\nrownames(radar_data) <- paste(\"Cluster\", radar_data$diet_cluster)\nradar_data <- radar_data[,-1]  # Remove cluster column\n\n# Add max and min rows required by fmsb\nradar_data <- rbind(\n  rep(max(radar_data), ncol(radar_data)),  # Max values\n  rep(min(radar_data), ncol(radar_data)),  # Min values\n  radar_data\n)\n\n# Plot\npar(mar = c(1, 1, 2, 1))\nradarchart(\n  radar_data,\n  pcol = rainbow(nrow(radar_data) - 2),\n  pfcol = scales::alpha(rainbow(nrow(radar_data) - 2), 0.3),\n  plwd = 2,\n  cglcol = \"grey\",\n  title = \"Comparison of Milk FA Profiles by Diet Cluster\"\n)\nlegend(\n  \"topright\",\n  legend = paste(\"Cluster\", 1:(nrow(radar_data) - 2)),\n  col = rainbow(nrow(radar_data) - 2),\n  lwd = 2,\n  pch = 16,\n  bty = \"n\"\n)\n```\n\n## Key Research Questions to Explore\n\n1. **Diet-Milk Relationship**\n   - Which fatty acids show the strongest correlation between diet and milk?\n   - Do some women transfer specific fatty acids more efficiently than others?\n   - Is there a time lag between changes in diet and changes in milk composition?\n\n2. **Temporal Changes**\n   - How do milk fatty acid profiles change over the first weeks postpartum?\n   - Are changes consistent across women or individual-specific?\n   - Do specific fatty acid classes show different temporal patterns?\n\n3. **Pattern Identification**\n   - Can women be grouped based on their milk fatty acid profiles?\n   - Do dietary patterns predict milk composition patterns?\n   - Is the Omega-6/Omega-3 ratio stable or variable over time?\n\n4. **Individual Variability**\n   - What is the extent of between-woman vs. within-woman variability?\n   - Are there fatty acids that show particularly high or low variability?\n   - Can maternal characteristics explain individual differences?\n\n## Conclusion\n\nThis synthetic dataset allows exploration of multiple analytical approaches for studying the relationship between maternal diet and breast milk fatty acid composition. The analyses range from simple visualization techniques to more complex multivariate and mixed-effect modeling approaches, providing a comprehensive toolkit for the student to apply to their real research data. = \"DHA (C22:6n3) in Breast Milk Over Time\",\n       x = \"Days Postpartum\",\n       y = \"Abundance (% of total FAs)\",\n       color = \"Woman ID\") +\n  theme_minimal() +\n  theme(legend.position = \"none\")  # Omit legend if too many women\n```\n\n### Analysis 2: Diet-Milk Correlations\n\nExamine correlations between dietary and milk fatty acid abundances:\n\n```r\n# Join diet and milk data for correlation analysis\njoined_data <- diet_long %>%\n  inner_join(milk_long, \n             by = c(\"woman_id\", \"timepoint\", \"days_postpartum\", \"fatty_acid\"),\n             suffix = c(\"_diet\", \"_milk\"))\n\n# Calculate correlations for each fatty acid\ncorrelations <- joined_data %>%\n  group_by(fatty_acid) %>%\n  summarize(correlation = cor(abundance_diet, abundance_milk, method = \"spearman\"),\n            p_value = cor.test(abundance_diet, abundance_milk, method = \"spearman\")$p.value)\n\n# Plot the correlations\nggplot(correlations, aes(x = reorder(fatty_acid, correlation), y = correlation)) +\n  geom_bar(stat = \"identity\", aes(fill = p_value < 0.05)) +\n  coord_flip() +\n  labs(title = \"Correlation Between Diet and Milk Fatty Acid Abundance\",\n       x = \"Fatty Acid\",\n       y = \"Spearman Correlation\",\n       fill = \"P < 0.05\") +\n  theme_minimal()\n\n# Correlation matrix of selected important FAs between diet and milk\nimportant_fas <- c(\"C18:2n6\", \"C18:3n3\", \"C20:4n6\", \"C20:5n3\", \"C22:6n3\")\nimportant_diet <- diet_data %>% \n  select(woman_id, timepoint, all_of(important_fas)) %>%\n  pivot_longer(cols = all_of(important_fas), \n               names_to = \"fatty_acid\", \n               values_to = \"diet_abundance\") %>%\n  mutate(diet_milk = paste0(\"diet_\", fatty_acid))\n\nimportant_milk <- milk_data %>%\n  select(woman_id, timepoint, all_of(important_fas)) %>%\n  pivot_longer(cols = all_of(important_fas), \n               names_to = \"fatty_acid\", \n               values_to = \"milk_abundance\") %>%\n  mutate(diet_milk = paste0(\"milk_\", fatty_acid))\n\ncombined <- important_diet %>%\n  select(woman_id, timepoint, diet_milk, diet_abundance) %>%\n  bind_rows(important_milk %>% \n              select(woman_id, timepoint, diet_milk, milk_abundance = milk_abundance)) %>%\n  pivot_wider(id_cols = c(woman_id, timepoint), \n              names_from = diet_milk, \n              values_from = c(diet_abundance, milk_abundance))\n\ncor_matrix <- cor(combined %>% select(-woman_id, -timepoint), use = \"pairwise.complete.obs\")\ncorrplot(cor_matrix, method = \"circle\", type = \"upper\", order = \"hclust\",\n         tl.col = \"black\", tl.srt = 45)\n```\n\n### Analysis 3: Multivariate Analysis (PCA)\n\nPrincipal Component Analysis to identify patterns in milk fatty acid composition:\n\n```r\n# Prepare data for PCA (wide format, just the fatty acid abundances)\nmilk_wide <- milk_data %>%\n  select(-days_postpartum)\n\n# Extract just the FA columns for PCA\nmilk_fa_cols <- milk_wide %>% select(-woman_id, -timepoint)\n\n# Run PCA\npca_result <- prcomp(milk_fa_cols, scale. = TRUE)\n\n# Extract scores\npca_scores <- as.data.frame(pca_result$x)\npca_scores$woman_id <- milk_wide$woman_id\npca_scores$timepoint <- milk_wide$timepoint\n\n# Plot PCA\nggplot(pca_scores, aes(x = PC1, y = PC2, \n                       color = factor(woman_id), \n                       shape = factor(timepoint))) +\n  geom_point(size = 3) +\n  labs(title = \"PCA of Breast Milk Fatty Acid Profiles\",\n       color = \"Woman ID\",\n       shape = \"Timepoint\") +\n  theme_minimal()\n\n# Loadings plot to see which fatty acids drive the variation\nloadings <- as.data.frame(pca_result$rotation)\nloadings$fatty_acid <- rownames(loadings)\n\nggplot(loadings, aes(x = PC1, y = PC2, label = fatty_acid)) +\n  geom_point() +\n  geom_text(vjust = -0.5) +\n  labs(title = \"PCA Loadings: Fatty Acids\") +\n  theme_minimal()\n```\n\n### Analysis 4: Heatmap Visualization\n\nCreate heatmaps to visualize patterns across women and fatty acids:\n\n```r\n# Prepare data for heatmap (woman at one timepoint, e.g., timepoint 3)\nmilk_wide_t3 <- milk_data %>%\n  filter(timepoint == 3) %>%\n  select(-timepoint, -days_postpartum) %>%\n  column_to_rownames(\"woman_id\")\n\n# Create heatmap\npheatmap(milk_wide_t3,\n         scale = \"column\",  # Scale by fatty acid\n         clustering_distance_rows = \"euclidean\",\n         clustering_distance_cols = \"euclidean\",\n         main = \"Breast Milk Fatty Acid Profiles at Timepoint 3\")\n\n# Compare across timepoints for a subset of important fatty acids\nimportant_fas <- c(\"C16:0\", \"C18:0\", \"C18:1n9\", \"C18:2n6\", \"C18:3n3\", \n                   \"C20:4n6\", \"C20:5n3\", \"C22:6n3\")\n\n# Time series heatmap\nmilk_long_subset <- milk_long %>%\n  filter(fatty_acid %in% important_fas) %>%\n  unite(\"woman_time\", c(woman_id, timepoint), sep = \"_T\")\n\nmilk_heatmap_data <- milk_long_subset %>%\n  pivot_wider(names_from = fatty_acid, values_from = abundance) %>%\n  column_to_rownames(\"woman_time\")\n\npheatmap(as.matrix(milk_heatmap_data),\n         scale = \"column\",\n         cluster_rows = TRUE,\n         cluster_cols = TRUE,\n         main = \"Breast Milk Fatty Acid Profiles Across Women and Time\")\n```\n\n### Analysis 5: Diet-Milk Transfer Efficiency\n\nCalculate and visualize the transfer efficiency from diet to milk:\n\n```r\n# Calculate ratio of milk to diet for each fatty acid\njoined_data <- diet_long %>%\n  inner_join(milk_long, \n             by = c(\"woman_id\", \"timepoint\", \"days_postpartum\", \"fatty_acid\"),\n             suffix = c(\"_diet\", \"_milk\"))\n\n# Calculate transfer ratio\njoined_data$transfer_ratio <- joined_data$abundance_milk / joined_data$abundance_diet\n\n# Calculate mean transfer ratio for each fatty acid\ntransfer_summary <- joined_data %>%\n  group_by(fatty_acid) %>%\n  summarize(mean_ratio = mean(transfer_ratio, na.rm = TRUE),\n            sd_ratio = sd(transfer_ratio, na.rm = TRUE))\n\n# Plot mean transfer ratios\nggplot(transfer_summary, aes(x = reorder(fatty_acid, mean_ratio), y = mean_ratio)) +\n  geom_bar(stat = \"identity\") +\n  geom_errorbar(aes(ymin = mean_ratio - sd_ratio, ymax = mean_ratio + sd_ratio), width = 0.2) +\n  coord_flip() +\n  labs(title = \"Fatty Acid Transfer Efficiency (Milk/Diet Ratio)\",\n       x = \"Fatty Acid\",\n       y = \"Mean Transfer Ratio (Milk/Diet)\") +\n  theme_minimal()\n\n# Does transfer efficiency change over time?\ntransfer_time <- joined_data %>%\n  filter(fatty_acid %in% important_fas) %>%\n  group_by(fatty_acid, timepoint) %>%\n  summarize(mean_ratio = mean(transfer_ratio, na.rm = TRUE),\n            sd_ratio = sd(transfer_ratio, na.rm = TRUE))\n\nggplot(transfer_time, aes(x = timepoint, y = mean_ratio, color = fatty_acid, group = fatty_acid)) +\n  geom_line() +\n  geom_point() +\n  geom_errorbar(aes(ymin = mean_ratio - sd_ratio, ymax = mean_ratio + sd_ratio), width = 0.2) +\n  labs(title = \"Fatty Acid Transfer Efficiency Over Time\",\n       x = \"Timepoint\",\n       y = \"Mean Transfer Ratio (Milk/Diet)\",\n       color = \"Fatty Acid\") +\n  theme_minimal()\n```\n\n### Analysis 6: Mixed-Effects Models\n\nExamine fatty acid changes over time while accounting for individual differences:\n\n```r\nlibrary(lme4)\nlibrary(lmerTest)\n\n# Example for DHA\ndha_data <- milk_long %>% \n  filter(fatty_acid == \"C22:6n3\")\n\n# Linear mixed model with random intercept by woman\ndha_model <- lmer(abundance ~ days_postpartum + (1|woman_id), data = dha_data)\nsummary(dha_model)\n\n# Visualize individual trajectories with overall trend\nggplot(dha_data, aes(x = days_postpartum, y = abundance, group = woman_id)) +\n  geom_line(alpha = 0.3) +\n  geom_smooth(aes(group = 1), method = \"lm\", color = \"red\") +\n  labs(title = \"DHA in Breast Milk Over Time with Overall Trend\",\n       x = \"Days Postpartum\",\n       y = \"DHA Abundance (%)\") +\n  theme_minimal()\n```\n\n### Analysis 7: Fatty Acid Group Analysis\n\nAnalyze by fatty acid groups (saturated, monounsaturated, omega-3, omega-6):\n\n```r\n# Create a function to classify fatty acids\nclassify_fa <- function(fa_name) {\n  if (grepl(\"C[0-9]+:0$\", fa_name)) {\n    return(\"Saturated\")\n  } else if (grepl(\"C[0-9]+:1\", fa_name)) {\n    if (grepl(\"t$\", fa_name)) {\n      return(\"Trans\")\n    } else {\n      return(\"Monounsaturated\")\n    }\n  } else if (grepl(\"n3$\", fa_name)) {\n    return(\"Omega-3\")\n  } else if (grepl(\"n6$\", fa_name)) {\n    return(\"Omega-6\")\n  } else if (grepl(\"t$\", fa_name)) {\n    return(\"Trans\")\n  } else {\n    return(\"Other\")\n  }\n}\n\n# Add classifications to the data\nmilk_long$fa_class <- sapply(milk_long$fatty_acid, classify_fa)\ndiet_long$fa_class <- sapply(diet_long$fatty_acid, classify_fa)\n\n# Calculate totals by class\nmilk_class_totals <- milk_long %>%\n  group_by(woman_id, timepoint, days_postpartum, fa_class) %>%\n  summarize(total_abundance = sum(abundance))\n\ndiet_class_totals <- diet_long %>%\n  group_by(woman_id, timepoint, days_postpartum, fa_class) %>%\n  summarize(total_abundance = sum(abundance))\n\n# Plot class distributions\nggplot(milk_class_totals, aes(x = factor(timepoint), y = total_abundance, fill = fa_class)) +\n  geom_boxplot() +\n  facet_wrap(~fa_class, scales = \"free_y\") +\n  labs(title\n\n::: {.cell}\n\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}